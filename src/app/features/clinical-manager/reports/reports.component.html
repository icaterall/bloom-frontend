<div class="reports-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Reports & Analytics</h1>
        <p class="page-subtitle">Comprehensive insights and statistics</p>
      </div>
      <div class="header-actions">
        <button
          class="btn-filter"
          (click)="showDateFilter = !showDateFilter"
        >
          <lucide-angular [img]="FilterIcon" class="btn-icon"></lucide-angular>
          Filter Dates
        </button>
        <button
          class="btn-export"
          (click)="exportReports()"
          [disabled]="!reports"
        >
          <lucide-angular [img]="DownloadIcon" class="btn-icon"></lucide-angular>
          Export
        </button>
      </div>
    </div>
  </div>

  <!-- Date Filter -->
  <div *ngIf="showDateFilter" class="date-filter-card">
    <div class="filter-content">
      <div class="filter-inputs">
        <div class="filter-input-group">
          <label>Start Date</label>
          <input type="date" [(ngModel)]="startDate" class="date-input" />
        </div>
        <div class="filter-input-group">
          <label>End Date</label>
          <input type="date" [(ngModel)]="endDate" class="date-input" />
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn-apply" (click)="applyDateFilter()">Apply</button>
        <button class="btn-reset" (click)="resetDateFilter()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Loading reports...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <p class="error-text">{{ error }}</p>
    <button class="btn-retry" (click)="loadReports()">Retry</button>
  </div>

  <!-- Reports Content -->
  <div *ngIf="!isLoading && !error && reports" class="reports-content">
    <!-- Date Range Info -->
    <div class="date-range-info">
      <lucide-angular [img]="CalendarIcon" class="info-icon"></lucide-angular>
      <span>
        Reports from {{ formatDate(reports.date_range.start_date) }} to {{ formatDate(reports.date_range.end_date) }}
      </span>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
      <div class="metric-card revenue">
        <div class="metric-header">
          <lucide-angular [img]="DollarSignIcon" class="metric-icon"></lucide-angular>
          <h3 class="metric-title">Total Revenue</h3>
        </div>
        <div class="metric-value">{{ formatCurrency(reports.payment_stats.total_revenue) }}</div>
        <div class="metric-subtitle">{{ reports.payment_stats.successful }} successful payments</div>
      </div>

      <div class="metric-card bookings">
        <div class="metric-header">
          <lucide-angular [img]="BarChart3Icon" class="metric-icon"></lucide-angular>
          <h3 class="metric-title">Total Bookings</h3>
        </div>
        <div class="metric-value">{{ reports.booking_stats.total }}</div>
        <div class="metric-subtitle">{{ reports.booking_stats.completed }} completed</div>
      </div>

      <div class="metric-card sessions">
        <div class="metric-header">
          <lucide-angular [img]="ActivityIcon" class="metric-icon"></lucide-angular>
          <h3 class="metric-title">Sessions</h3>
        </div>
        <div class="metric-value">{{ reports.session_stats.total }}</div>
        <div class="metric-subtitle">{{ reports.session_stats.completed }} completed</div>
      </div>

      <div class="metric-card children">
        <div class="metric-header">
          <lucide-angular [img]="BabyIcon" class="metric-icon"></lucide-angular>
          <h3 class="metric-title">Children</h3>
        </div>
        <div class="metric-value">{{ reports.children_stats.total }}</div>
        <div class="metric-subtitle">{{ reports.children_stats.enrolled }} enrolled</div>
      </div>
    </div>

    <!-- Detailed Statistics Sections -->
    <div class="stats-sections">
      <!-- Booking Statistics -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Booking Statistics</h2>
          <lucide-angular [img]="BarChart3Icon" class="stats-icon"></lucide-angular>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Total Bookings</span>
            <span class="stat-value">{{ reports.booking_stats.total }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Confirmed</span>
            <span class="stat-value confirmed">{{ reports.booking_stats.confirmed }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Completed</span>
            <span class="stat-value completed">{{ reports.booking_stats.completed }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Cancelled</span>
            <span class="stat-value cancelled">{{ reports.booking_stats.cancelled }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">No Shows</span>
            <span class="stat-value no-show">{{ reports.booking_stats.no_shows }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Pending Review</span>
            <span class="stat-value pending">{{ reports.booking_stats.pending_review }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Online</span>
            <span class="stat-value">{{ reports.booking_stats.online }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">In Centre</span>
            <span class="stat-value">{{ reports.booking_stats.in_centre }}</span>
          </div>
        </div>
      </div>

      <!-- Payment Statistics -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Payment Statistics</h2>
          <lucide-angular [img]="DollarSignIcon" class="stats-icon"></lucide-angular>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Total Payments</span>
            <span class="stat-value">{{ reports.payment_stats.total }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Total Revenue</span>
            <span class="stat-value revenue">{{ formatCurrency(reports.payment_stats.total_revenue) }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Successful</span>
            <span class="stat-value completed">{{ reports.payment_stats.successful }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Failed</span>
            <span class="stat-value cancelled">{{ reports.payment_stats.failed }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Pending</span>
            <span class="stat-value pending">{{ reports.payment_stats.pending }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Success Rate</span>
            <span class="stat-value">{{ reports.payment_stats.success_rate }}%</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Card Payments</span>
            <span class="stat-value">{{ reports.payment_stats.card }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Online Banking</span>
            <span class="stat-value">{{ reports.payment_stats.online_banking }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Cash Payments</span>
            <span class="stat-value">{{ reports.payment_stats.cash }}</span>
          </div>
        </div>
      </div>

      <!-- Session Statistics -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Session Statistics</h2>
          <lucide-angular [img]="ActivityIcon" class="stats-icon"></lucide-angular>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Total Sessions</span>
            <span class="stat-value">{{ reports.session_stats.total }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Upcoming</span>
            <span class="stat-value confirmed">{{ reports.session_stats.upcoming }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Completed</span>
            <span class="stat-value completed">{{ reports.session_stats.completed }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Cancelled</span>
            <span class="stat-value cancelled">{{ reports.session_stats.cancelled }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">No Shows</span>
            <span class="stat-value no-show">{{ reports.session_stats.no_shows }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Avg Duration</span>
            <span class="stat-value">{{ reports.session_stats.avg_duration }} min</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Completion Rate</span>
            <span class="stat-value">{{ reports.session_stats.completion_rate }}%</span>
          </div>
        </div>
      </div>

      <!-- Children Statistics -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Children Statistics</h2>
          <lucide-angular [img]="BabyIcon" class="stats-icon"></lucide-angular>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Total Children</span>
            <span class="stat-value">{{ reports.children_stats.total }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Enrolled</span>
            <span class="stat-value completed">{{ reports.children_stats.enrolled }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">In Assessment</span>
            <span class="stat-value pending">{{ reports.children_stats.in_assessment }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">On Waitlist</span>
            <span class="stat-value waitlist">{{ reports.children_stats.on_waitlist }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Not Enrolled</span>
            <span class="stat-value">{{ reports.children_stats.not_enrolled }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Autism</span>
            <span class="stat-value">{{ reports.children_stats.autism }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">GDD</span>
            <span class="stat-value">{{ reports.children_stats.gdd }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Suspected</span>
            <span class="stat-value">{{ reports.children_stats.suspected }}</span>
          </div>
        </div>
      </div>

      <!-- Waitlist Statistics -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Waitlist Statistics</h2>
          <lucide-angular [img]="ClockIcon" class="stats-icon"></lucide-angular>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Total on Waitlist</span>
            <span class="stat-value">{{ reports.waitlist_stats.total }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Avg Days</span>
            <span class="stat-value">{{ reports.waitlist_stats.avg_days }} days</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Max Days</span>
            <span class="stat-value">{{ reports.waitlist_stats.max_days }} days</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Long Waitlist (90+ days)</span>
            <span class="stat-value long-waitlist">{{ reports.waitlist_stats.long_waitlist }}</span>
          </div>
        </div>
      </div>

      <!-- Status Breakdown -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Status Breakdown</h2>
          <lucide-angular [img]="PieChartIcon" class="stats-icon"></lucide-angular>
        </div>
        <div class="breakdown-list">
          <div *ngFor="let status of reports.status_breakdown" class="breakdown-item">
            <div class="breakdown-header">
              <span class="breakdown-status" [ngClass]="getStatusColor(status.status)">
                {{ status.status | titlecase }}
              </span>
              <span class="breakdown-count">{{ status.count }}</span>
            </div>
            <div class="breakdown-bar">
              <div 
                class="breakdown-bar-fill" 
                [style.width.%]="parseFloat(status.percentage)"
                [ngClass]="getStatusColor(status.status)"
              ></div>
            </div>
            <div class="breakdown-percentage">{{ status.percentage }}%</div>
          </div>
        </div>
      </div>

      <!-- Therapist Performance -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Therapist Performance</h2>
          <lucide-angular [img]="UsersIcon" class="stats-icon"></lucide-angular>
        </div>
        <div class="therapist-table">
          <table>
            <thead>
              <tr>
                <th>Therapist</th>
                <th>Total Sessions</th>
                <th>Completed</th>
                <th>Cancelled</th>
                <th>No Shows</th>
                <th>Unique Children</th>
                <th>Avg Duration</th>
                <th>Completion Rate</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let therapist of reports.therapist_stats">
                <td>
                  <div class="therapist-name">{{ therapist.name }}</div>
                  <div class="therapist-email">{{ therapist.email }}</div>
                </td>
                <td>{{ therapist.total_sessions }}</td>
                <td class="completed">{{ therapist.completed_sessions }}</td>
                <td class="cancelled">{{ therapist.cancelled_sessions }}</td>
                <td class="no-show">{{ therapist.no_show_sessions }}</td>
                <td>{{ therapist.unique_children }}</td>
                <td>{{ therapist.avg_session_duration }} min</td>
                <td>{{ therapist.completion_rate }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Monthly Trends -->
      <div class="stats-card">
        <div class="stats-header">
          <h2 class="stats-title">Monthly Trends (Last 6 Months)</h2>
          <lucide-angular [img]="TrendingUpIcon" class="stats-icon"></lucide-angular>
        </div>
        <div class="trends-table">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Bookings</th>
                <th>Completed</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let trend of reports.monthly_trends">
                <td>{{ formatMonth(trend.month) }}</td>
                <td>{{ trend.bookings_count }}</td>
                <td class="completed">{{ trend.completed_count }}</td>
                <td class="revenue">{{ formatCurrency(trend.revenue) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

